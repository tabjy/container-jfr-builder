#!/bin/bash -e

set -x # enable echo

pushd src

mv /tmp/src container-jfr
git clone https://github.com/openjdk/jmc.git
git clone https://github.com/rh-jmc-team/container-jfr-core.git

pushd jmc

pushd releng/third-party
mvn p2:site
mvn jetty:run &
popd

pushd core
mvn install -DskipTests=true -Dspotbugs.skip=true
popd

mvn install -DskipTests=true -Dspotbugs.skip=true
kill $!
popd

pushd container-jfr-core
./gradlew build -x test 
popd

pushd container-jfr
./gradlew build -x test 

pushd web-client
npm install
popd

./gradlew copyWebClient

#mkdir -p ./build/distributions/
#curl localhost:8000/container-jfr.tar -o ./build/distributions/container-jfr.tar

tar xf ./build/distributions/container-jfr.tar
mv ./container-jfr/bin/* ${APP_ROOT}/bin/
mv ./container-jfr/lib/* ${APP_ROOT}/lib/
mv ./build/extra-directory/web-client ${APP_ROOT}/lib/web-client

popd

popd

rm -rf src/*